# DSpace utilities

This repository contains utilities meant to be run on a developer workstation
to support the setup and maintenance of the DSpace instance hosting the latest
version of the UVALIB open access repository.

Additionally, the "remote" directory contains utilities meant to be run from a
developer account on the DSpace instance itself.

DSpace import requires a user account on the DSpace instance with administrator
privileges.

## Developer desktop utilities

Scripts from the "bin" directory are meant to be run on a developer
workstation.

### dspace_sh

Run a command on the DSpace instance.

With no command argument, this opens an interactive shell on the remote system.

### dspace_cp

Copy files to or from the DSpace instance.

The last argument indicates the direction:
* If it begins with ":" or "scp:" then it is interpreted as the remote
    destination directory and all prior arguments are interpreted as local
    source files and/or directories.
* If it is "." or "..", or begins with "./", "../" then it is interpreted as
    the local destination directory and all prior arguments are interpreted as
    remote source files and/or directories.

For the variant `dspace_cp_to` all arguments are interpreted as local source
files and/or directories which will be copied to the home directory of the
remote account.

For the variant `dspace_cp_from` all arguments are interpreted as remote source
files and/or directories relative to the home directory of the remote account
which will be copied to the local current working directory.

### dspace_lookup

Get JSON details of a DSpace item.

The item may be a collection, however DSpace only returns metadata about the
collection itself and does not provide a way to get the items associated with
the collection.

### dspace_solr

Open the DSpace Solr admin page on a local browser, creating an ssh tunnel if
necessary.

The tunnel will persist in the background after the command is done.

### dspace_solr_export

Retrieve DSpace Solr search records.

### dspace_update_home

A convenience script for copying the files of "remote/bin" to the user's DSpace
home ~/bin directory.

### dspace_import

This script performs `bin/dspace_import_zip` to generate an import zip file,
copies it to the remote system, and then runs `remote/bin/dspace_import`.

All options are passed to the local `bin/dspace_import_zip` script except for
"--eperson" and "--collection" which are passed to `remote/bin/dspace_import`.

#### Prerequisites

Remote utilities are expected to be installed in your DSpace account.
(See `dspace_update_home`.)

### dspace_import_zip

This is a program for generating a zip file containing a hierarchy import items
adhering to ["DSpace Simple Archive Format"][SAF] from a local directory
hierarchy of export items from Libra Open in the $EXPORT_DIR directory.

Normally, the program creates a single zip file "\$IMPORT_DIR.zip" unless
--batch-size or --batch-count is given.
In these cases, one or more zip files are created named "\$IMPORT_DIR-nnn.zip"
where "nnn" is a zero-filled number.
(Run `bin/dspace_import_zip --help` for all options.)

The resulting zip file(s) can be copied to DSpace for use with the remote
dspace_import script to bulk submit the items to DSpace.

#### Prerequisites

The program assumes that the Ruby version indicated by ".ruby-version" is
installed via `rvm` with a gemset named by ".ruby-gemset".


## DSpace instance utilities

Scripts from the "remote/bin" directory are meant to be copied to the
developer's account directory on the DSpace instance in "\$HOME/bin"
(which can be accomplished with `dspace_update_home`).

### dspace

Run a DSpace command.

### dspace_restart

Restart DSpace with updated configuration from
https://github.com/uvalib/dspace_config

Because the GitHub repository is automated to deploy after a push,
this script should not be necessary normally.

### dspace_retheme

Restart DSpace UI with updated configuration from
https://github.com/uvalib/dspace_theme

Because the GitHub repository is automated to deploy after a push,
this script should not be necessary normally.

### dspace_export

Export DSpace item records.

### dspace_solr_export

Retrieve DSpace Solr search records.

### dspace_import

Takes a zip file (generated by `bin/dspace_import_zip`) and bulk submits the
items to DSpace.

The DSpace import process is rather slow and happens in several phases:
* First, items are extracted from the zip file into a subdirectory created
    under `/opt/dspace/imports/importSAF`.
* This expanded data is used to create data for each item.
* Items are submitted to the Solr index.
* Finally, the items will appear in the DSpace UI in the target collection.

Imported items will only appear in DSpace if all phases are completed.
Failure of any item will result in failure of all items to be submitted.

Although there is no stated limit on the size of valid bulk submissions,
there can be problems with submitting a large number of items, and those
problems may not necessarily result in log errors to help identify the problem.

The ["Batch Metadata Editing"][CSV] page, regarding CSV imports, suggests
limiting batches to 1000 items.
While this may or may not apply to SAF imports, it might be wise to break
large bulk submissions into batches.


<!---------------------------------------------------------------------------->
<!-- Directory link references used above:
REF --------- LINK -------------------------- TOOLTIP ------------------------>
[CSV]:        https://wiki.lyrasis.org/display/DSDOC8x/Batch+Metadata+Editing
[SAF]:        https://wiki.lyrasis.org/display/DSDOC8x/Importing+and+Exporting+Items+via+Simple+Archive+Format
