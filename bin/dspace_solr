#! /bin/bash
#
# View the DSpace Solr admin page.
#
# Usage: dspace_solr [DEPLOYMENT] [-chrome|-firefox]

PROGRAM=`realpath "$0"`
BIN_DIR=`dirname "$PROGRAM"`

source "$BIN_DIR/dspace_values"

readonly SOLR_HOST="$DSPACE_PRIVATE"
readonly SOLR_PORT=8983
readonly SOLR_CORE='search'

readonly LOCAL_HOST='localhost'
readonly LOCAL_PORT=$SOLR_PORT
readonly LOCAL_SOLR="http://$LOCAL_HOST:$LOCAL_PORT/solr"
readonly LOCAL_URL="$LOCAL_SOLR/#/$SOLR_CORE/core-overview"

readonly CHROME='google-chrome'
readonly FIREFOX='firefox'

# =============================================================================
# Select local browser on the command line.
# =============================================================================

BROWSER="$CHROME"

for ARG in "$@" ; do
    case "$ARG" in
        -google*|-*chrome|google*|*chrome)  BROWSER="$CHROME" ;;
        -firefox|firefox)                   BROWSER="$FIREFOX" ;;
        *)                                  abort "unexpected arg '$ARG'" ;;
    esac
done

# =============================================================================
# Functions
# =============================================================================

function background # command...
{
    "$@" > /dev/null 2>&1 &
}

# =============================================================================
# Test to determine whether an SSH tunnel is needed.
# =============================================================================

curl -s "$LOCAL_URL" > /dev/null
if [[ $? -ne 0 ]] ; then
    background ssh -N -L "$LOCAL_PORT:$LOCAL_HOST:$SOLR_PORT" $SOLR_HOST
    echo "STARTED SSH TUNNEL; pid = $!"
fi

# =============================================================================
# Open local browser to view the remote Solr admin page.
# =============================================================================

background $BROWSER "$LOCAL_URL"
