#! /bin/bash
#
# Extract exports from LibraOpen for use in importing to DSpace.
#
# Usage: dspace_libra_export [OPTIONS]
#
# OPTIONS
#   --force         Overwrite existing destination subdirectory.
#   --common DIR    Common root for export and import directories.
#   --export NAME   Destination subdirectory name for copied exports.
#   --start  DATE   Export items submitted from this date through the end date.
#   --end    DATE   Export items submitted up to this date (default: today).
#
# If a common directory is given, $LIBRA_EXPORT_SRC is copied there rather than
# the default ($COMMON_ROOT from dspace_values).
#
# If an export name is given, $LIBRA_EXPORT_SRC copied into a subdirectory with
# that name rather than the default ($EXPORT_DIR from dspace_values).

PROGRAM=`realpath "$0"`
BIN_DIR=`dirname "$PROGRAM"`
PRJ_DIR=`dirname "$BIN_DIR"`

source "$BIN_DIR/dspace_values"

# Terraform repo on the local system.
readonly TI_PRJ=`realpath "$PRJ_DIR/../terraform-infrastructure"`

# Properties of the remote system.
readonly LIBRA_HOST='10.130.110.92'
readonly LIBRA_USER='ec2-user'
readonly LIBRA_EXPORT_SRC='libra-open-export' # Export subdirectory name.

# =============================================================================
# Process command line arguments.
# =============================================================================

OUT_DIR=''
OUT_NAME=''
START_DATE=''
END_DATE=''
FORCE=''
HELP=''

while [[ $# -gt 0 ]] ; do
    case "$1" in
        --help)     HELP=true;       shift 1 ;;
        --force)    FORCE=true;      shift 1 ;;
        --common)   OUT_DIR="$2";    shift 2 ;;
        --export)   OUT_NAME="$2";   shift 2 ;;
        --start)    START_DATE="$2"; shift 2 ;;
        --end)      END_DATE="$2";   shift 2 ;;
        *)          abort "invalid arg '$ARG'" ;;
    esac
done

[[ "$OUT_DIR"    ]] || OUT_DIR="$COMMON_ROOT"
[[ "$OUT_NAME"   ]] || OUT_NAME="$EXPORT_DIR"
[[ "$START_DATE" ]] || START_DATE='2000-01-01'  # Start date is required.
[[ "$END_DATE"   ]] || END_DATE=`date -I`       # Default end date is today.

# =============================================================================
# Early exit for "--help".
# =============================================================================

if [[ "$HELP" ]] ; then
    echo "Usage: $PROGNAME [OPTIONS]"
    cat <<'EOF'
    OPTIONS:
    --force             Replace the target output directory
    --common DIR_PATH   Root directory of the output directory
    --export DIR_NAME   Name of the output directory
    --start DATE        Export items created on or after the given date
    --end DATE          Export items created up through the given date
EOF
    exit 0
fi

# =============================================================================
# Avoid overwriting an existing export subdirectory.
# =============================================================================

DST_DIR="$OUT_DIR/$OUT_NAME"

if [[ -e "$DST_DIR" ]] ; then
    if [[ "$FORCE" ]] ; then
        announce "Removing existing '$DST_DIR'"
        rm -rf "$DST_DIR"
    else
        abort "$OUT_DIR already contains an export subdirectory ($OUT_NAME)"
    fi
fi

mkdir -p "$OUT_DIR"

# =============================================================================
# Ensure terraform-infrastructure repo is on the local developer workstation.
# =============================================================================

if [[ ! -d "$TI_PRJ" ]] ; then
    TI_SRC='git@gitlab.com:uvalib/terraform-infrastructure.git'
    abort "missing $TI_PRJ" "need to run: git clone $TI_SRC"
fi

# =============================================================================
# Make Docker credentials available.
# =============================================================================

cd "$TI_PRJ/docker.lib.virginia.edu/production/keys" || exit $?
ENCRYPTED='docker_production.pem.cpt'
UNENCRYPTED=`basename "$ENCRYPTED" .cpt`
if [[ ! -f "$UNENCRYPTED" ]] ; then
    announce "Generating '$UNENCRYPTED'"
    SECRET='docker.lib.virginia.edu/production/keys/docker_production.pem'
    "$TI_PRJ/scripts/decrypt-key.ksh" "$ENCRYPTED" "$SECRET" || exit $?
fi
REMOTE_CREDENTIALS="$PWD/$UNENCRYPTED"

#announce "Interactive shell to $LIBRA_HOST"
#exec ssh -i "$REMOTE_CREDENTIALS" "$LIBRA_USER@$LIBRA_HOST"

# =============================================================================
# Ensure credentials are in place for the playbook.
# =============================================================================

cd "$TI_PRJ/libra-aptrust/production/ansible" || exit $?

ENCRYPTED='aptrust-production.env.cpt'
UNENCRYPTED=`basename "$ENCRYPTED" .cpt`
if [[ ! -f "$UNENCRYPTED" ]] ; then
    announce "Generating '$UNENCRYPTED'"
    SECRET='aptrust/production/ansible/aptrust-production.env'
    "$TI_PRJ/scripts/decrypt-key.ksh" "$ENCRYPTED" "$SECRET" || exit $?
fi

LIBRA_GEN='libra-open.env.generated'
if [[ ! -f "$LIBRA_GEN" ]] ; then
    announce "Generating '$LIBRA_GEN'"
    LIBRA_DIR="$TI_PRJ/libraopen.lib.virginia.edu"
    LIBRA_ENV="$LIBRA_DIR/production/backend/environment.vars"
    awk -F '"' '{ printf "%s: \"%s\"\n", $4, $8 }' "$LIBRA_ENV" > "$LIBRA_GEN"
fi

# =============================================================================
# Set up Terraform
# =============================================================================

cd "$TI_PRJ/libra-aptrust/production" || exit $?

[[ "$AWS_REGION" ]] || export AWS_REGION='us-east-1'
terraform init || exit $?

T_ARGS=(-auto-approve)
[[ "$START_DATE" ]] && T_ARGS+=(-var "export_start_date=$START_DATE")
[[ "$END_DATE"   ]] && T_ARGS+=(-var "export_end_date=$END_DATE")
terraform apply "${T_ARGS[@]}" || exit $?

# =============================================================================
# Perform the LibraOpen export and recursively copy to $DST_DIR.
# =============================================================================

cd "$TI_PRJ/libra-aptrust/production/ansible" || exit $?

SRC_DIR="/mnt/scratch/$LIBRA_EXPORT_SRC"

announce 'Clearing remote export directory'
ansible-playbook clean_libra_open_export.yml || exit $?

announce "Generating remote export $START_DATE thru $END_DATE"
ansible-playbook deploy_libra_open_export.yml || exit $?

announce "Verify export start for $START_DATE thru $END_DATE"
CONTAINER_NAME="${LIBRA_EXPORT_SRC}-production"
GET_CONTAINER_ID="\`sudo docker stats --no-stream | awk '\$2 == \"$CONTAINER_NAME\" { print \$1 }'\`"
CHECK_CONTAINER_ID="CONTAINER_ID=$GET_CONTAINER_ID && test \$CONTAINER_ID"
ssh -i "$REMOTE_CREDENTIALS" "$LIBRA_USER@$LIBRA_HOST" "$CHECK_CONTAINER_ID" ||
    abort 'no Docker container active'

announce "Waiting for export completion for $START_DATE thru $END_DATE"
ssh -i "$REMOTE_CREDENTIALS" "$LIBRA_USER@$LIBRA_HOST" "
    PAUSE=5
    PREVIOUS=0
    while sleep \$PAUSE ; do
        STATE=''
        COUNT=\`ls '$SRC_DIR' 2>/dev/null | wc -l\`
        if test \$COUNT -eq 0 ; then
            STATE='not started'
        elif test \$PREVIOUS -lt \$COUNT ; then
            STATE=\"\$COUNT exported\"
        elif $CHECK_CONTAINER_ID ; then
            STATE=\"\$COUNT exported\"
        else
            exit
        fi
        echo waiting - \$STATE
        PREVIOUS=\$COUNT
    done
"

announce "Copying $LIBRA_EXPORT_SRC to $DST_DIR"
scp -r -i "$REMOTE_CREDENTIALS" "$LIBRA_USER@$LIBRA_HOST:$SRC_DIR" "$DST_DIR"
